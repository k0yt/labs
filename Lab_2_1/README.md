# Задание 2.1 Атака на беспроводные сети WiFi 802.11

### Основные понятия

1. **Wi-Fi (или беспроводная локальная сеть)** основана на наборе стандартов, известных как семейство стандартов IEEE 802.11. Эти стандарты определяют протоколы и процедуры, которые позволяют беспроводным устройствам обмениваться данными через радиочастотный спектр.
2. **Беспроводная точка доступа (Access Point)** - беспроводная точка доступа (ТД AP) является центральным устройством в беспроводной сети. Она создает беспроводную среду, в которой устройства могут обмениваться данными. Точка доступа подключается к проводной сети и обеспечивает беспроводную связь с устройствами, такими как ноутбуки, смартфоны, планшеты и другие Wi-Fi-совместимые устройства.
3. **Клиентские устройства** - клиентские устройства, такие как ноутбуки, смартфоны или планшеты, являются конечными устройствами, которые подключаются к беспроводной точке доступа. Они используют беспроводной адаптер (Wi-Fi адаптер), чтобы установить связь с точкой доступа и обмениваться данными.
4. **Радиочастотный спектр** Wi-Fi работает в определенном диапазоне радиочастот, который регулируется правительственными организациями. Стандарты Wi-Fi (например, 802.11b/g/n/ac/ax) определяют различные частотные диапазоны, такие как 2,4 ГГц и 5 ГГц, на которых устройства могут взаимодействовать.
5. **Беспроводная Wi-Fi карта (или беспроводной Wi-Fi адаптер)** – любая сетевая карта, способная подключаться к сети Wi-Fi. В ноутбуках и телефонах они встроены внутрь корпуса, в настольных компьютерах обычно представляют собой внешнее устройство, подключаемое по USB.
6. **Режим монитора (Monitor Mode)** – свойство некоторых беспроводных адаптеров принимать пакеты данных, которые предназначены не только для них, но и для других беспроводных устройств.
7. **Сетевой интерфейс** – имя, условное обозначение в Linux сетевых карт/адаптеров.
8. **Каналы** - в радиочастотном спектре Wi-Fi доступны различные каналы. Устройства Wi-Fi могут выбирать каналы для установления связи с точкой доступа. Оптимальный выбор каналов помогает избежать помех от других беспроводных устройств.
9. **Протоколы и процедуры**: Wi-Fi стандарты определяют протоколы и процедуры для установления связи, аутентификации, шифрования данных и управления сетью. Например, протоколы как WPA2 (Wi-Fi Protected Access 2) и WPA3 обеспечивают безопасность Wi-Fi сети путем шифрования данных. WPA2 и WPA3 – технологии защищённого доступа к Wi-Fi, пришли на смену устаревшим технологиям WEP, WPA.
10. **ESSID и SSID** – у любой беспроводной сети есть уникальный идентификатор – SSID (service set identifier), который собственно и отображается как имя сети при просмотре списка доступных сетей. Строго говоря, ESSID и SSID это не одно и то же, но в аудите Wi-Fi эти термины часто используются как взаимозаменяемые. 
11. **BSSID** – это MAC-адрес беспроводной карты. Пример MAC-адреса: 50:46:5D:6E:8C:20.
12. **Рукопожатие (также хэндшейк, handshake)** – данные, которыми обмениваются Станция и Точка Доступа в момент создания Wi-Fi соединения. Эти данные содержат информацию, позволяющую подобрать пароль от сети Wi-Fi.
13. **Онлайн перебор пароля Wi-Fi** – метод подбора пароля, который заключается в подключении к Точке Доступа с различными кандидатами в пароли. Практически не применяется из-за крайне низкой скорости перебора. Преимущества этого метода — не требуется беспроводной адаптер с поддержкой режима монитора. Недостаток — этот метод крайне медленный.
14. **Офлайн перебор пароля Wi-Fi** – метод подбора пароля, который заключается в захвате Рукопожатия и подборе такого пароля, который бы соответствовал этому рукопожатию. Этот подбор не требует подключения к Точке Доступа и выполняется на много порядков быстрее, чем онлайн перебор. Также он может выполняться на вычислительных мощностях видеокарт, что увеличивает скорость перебора ещё на несколько порядков.
15. **Сарtivе портал** - страница авторизации пользователя в сети WiFi  
16. **Brute Force по словарю** - Тестирование нескольких паролей из словаря или другого источника для одной учетной записи. Имеет хорошее соотношение затраченных ресурсов к полученным результатам.
17. **Классический Brute Force** - (также полный перебор) – метод атаки на пароль, заключающийся в переборе всех возможных вариантов пароля. Требует много времени и вычислительных ресурсов.
18. **Credential Stuffing** - Тестирование пар логин/пароль, полученных в результате взлома другого ресурса
19. **Password Spraying** - Тестирование одного слабого пароля для большого количества различных учетных записей

### WiFi - Wireless Fidelity

WiFi - это промышленное название технологии беспроводного обмена данными, относящееся к группе стандартов организации беспроводных сетей IEEE 802.11. В некоторой степени, термин Wi-Fi является синонимом 802.11b, поскольку стандарт 802.11b был первым в группе стандартов IEEE 802.11 получившим широкое распространение. Однако сегодня термин Wi-Fi в равной степени относится к любому из стандартов 802.11b, 802.11a, 802.11g и 802.11n, 802.11ac.

![Стек протоколов IEEE 802.11](802.1.png)

Wi-Fi Alliance занимается аттестацией Wi-Fi продукции, что позволяет гарантировать, что вся 802.11 продукция, поступающая на рынок, соответствует спецификации стандарта. К сожалению, стандарт 802.11a, использующий частоту 5ГГц, не совместим со стандартами 802.11b/g, использующим частоту 2,4ГГц, поэтому рынок Wi-Fi продукции остается фрагментированным. Для нашей страны это неактуально, поскольку для использования аппаратуры стандарта 802.11а, требуется специальное разрешение и она не получила здесь широкого распространения, к тому же подавляющее большинство устройств, поддерживающих стандарт 802.11a, поддерживают также и стандарт 802.11b или 802.11g, что позволяет считать относительно совместимыми все продаваемые в данный момент WiFi устройства. Новый стандарт 802.11n поддерживает обе эти частоты.

### Основные компоненты и принципы работы Wi-Fi следующие:

Общение между беспроводной точкой доступа и клиентскими устройствами происходит через радиосигналы, которые передаются в виде пакетов данных. Wi-Fi использует различные методы модуляции и демодуляции сигналов для передачи информации по радиочастотам.

Радиус действия со штатными антеннами (обычно усиление 2dBi) популярных точек доступа и маршрутизаторов стандарта 802.11g, при условии, что они соединяются с устройством, имеющим антенну с аналогичным усилением, можно примерно оценить в 150м на открытой местности и 50 м в помещении, более точные цифры для разных стандартов приведены ниже в таблице, посвященной скорости передачи.

Препятствия в виде кирпичных стен и металлических конструкций могут уменьшить радиус действия Wi-Fi сети на 25% и более. Поскольку стандарты 802.11a/ac используют частоты выше, чем стандарты 802.11b/g, он является наиболее чувствительным к различного рода препятствиям. На радиус действия Wi-Fi сетей, поддерживающих стандарт 802.11b или 802.11g, влияют также помехи, исходящие от микроволновых печей. Ниже показана таблица с приблизительными потерями эффективности сигнала Wi-Fi с частотой 2.4 ГГц при прохождении через различные препятствия.

|Тип препятствия| Дополнительные потери (dB)|  Эффективное расстояние|
|---|---|---|
|Открытое пространство| 0| 100%|
|Окно без тонировки <br> (отсутствует метализированное покрытие) | 3| 70%|
|Окно с тонировкой <br>(метализированное покрытие)| 5-8| 50%|
|Деревянная стена | 10|  30%|
|Межкомнатная стена <br>(15,2 см) | 15-20| 15%|
|Несущая стена <br>(30,5 см)| 20-25 |10-15%|
|Бетонный пол/потолок | 15-25 |10-15%|
|Монолитное железобетонное <br>перекрытие | 20-25| 10%|

Ещё одним существенным препятствием может оказаться листва деревьев, поскольку она содержит воду, поглощающую микроволновое излучение данного диапазона. Проливной дождь ослабляет сигналы в диапазоне 2.4GHz с интенсивностью до 0.05 dB/км, густой туман вносит ослабление 0.02 dB/км, а в лесу (густая листа, ветви) сигнал может затухать с интенсивностью до 0.5дб/метр.

Увеличить радиус действия Wi-Fi сети можно посредством объединения в цепь нескольких беспроводных точек доступа или маршрутизаторов, а также путём замены штатных антенн, установленных на сетевых картах и точках доступа, на более мощные.

Существует несколько стандартов 802.11

|Протокол|  Используемая <br>частота|  Максимальная <br>теоретическая<br> скорость| Типичная скорость <br>на практике| Дальность связи <br>в помещении| Дальность связи <br>на открытой местности|
|---|---|---|---|---|---|
|802.11b| 2.4ГГц  |11Мбит/cек  | 0.4Мбайт/cек|  38|  140
|802.11a| 5ГГц  |54Мбит/cек  | 2.3Мбайт/cек|  35|  120
|802.11g| 2.4ГГц  |54Мбит/cек  | 1.9Мбайт/сек|  38|  140
|802.11n| 2.4ГГц, 5ГГц|  600Мбит/cек|  7.4Мбайт/cек|  70|  250

Максимальную пропускную способность могут предложить сети, поддерживающие стандарт 802.11ac - до 2167 Мбит/сек

### Безопасность, шифрование и авторизация пользователей в беспроводных сетях.

Изначально для обеспечения безопасности в сетях 802.11 применялся алгоритм **WEP(Wired Equivalent Privacy)**, включавший в себя алгоритм шифрования RC4 c 40-битным или 104-битным ключом и средства распределения ключей между пользователями, однако в 2001 году в нём была найдена принципиальная уязвимость, позволяющая получить полный доступ к сети за конечное (и весьма небольшое время) вне зависимости от длины ключа. Категорически не рекомендуется к использованию в настоящее время. Поэтому в 2003 году была принята программа сертификации средств беспроводной связи под названием **WPA(Wi-Fi Protected Access)**, устранявшая недостатки предыдущего алгоритма. С 2006 года все WiFi-устройства обязаны поддерживать новый стандарт **WPA2**, который отличается от WPA поддержкой более современного алгоритма шифрования AES с 256-битным ключом. Также в WPA появился механизм защиты передаваемых пакетов с данными от перехвата и фальсификации. Именно такое сочетание (WPA2/AES) рекомендуется сейчас к использованию во всех закрытых сетях. WPA3 - это самая последняя и улучшенная версия WPA2.

| |WEP|WPA|WPA2|
|---|---|---|---|
|Протокол шифрования|Алгоритм RC4 с ручным назначением ключей|Протокол TKIP, основанный на RC4|Протокол CCMP с ключами AES длиной 128 бит 
|Целостность данных|Линейная хэш-функция|Криптографическая хэш-функция|Криптографическая хэш-функция
|Управление ключами|Нет|Да|Да
|Обнаружение атак типа replay|Нет|Да|Да

Возможности беспроводных сетей, работающих в режимах WPA/WPA2-Personal/Enterprise 

|WPA/WPA2-Personal|WPA/WPA2-Enterprise|
|---|---|
|Централизованно неуправляемый режим аутентификации на основе PSK (используется вводимая вручную парольная фраза, общая для всех пользователей сети)|Каждому пользователю назначаются индивидуальные права доступа после IEEE 802.1X-аутентификации |
|Не требуется сервер аутентификации|Требуется сервер аутентификации IEEE 802.1X ААА с поддержкой ЕАР и база аутентификационных данных|
|Ключи шифрования данных уникальны для каждой сессии|Ключи шифрования данных уникальны для каждой сессии

У WPA есть два режима авторизации пользователей в беспроводной сети - при помощи RADIUS-сервера авторизации (ориентирован на корпоративных пользователей и крупные сети, в этом материале не рассматривается) и **WPA-PSK(Pre Shared Key)**, который предлагается использовать в домашних сетях, а также в небольших офисах. В этом режиме авторизация по паролю (длиной от 8 до 64 символов) производится на каждом узле сети.

![Подключение клиента к беспроводной сети](4handshake.png)

WPA-handshake прилетает от клиента во втором пакете рукопожатия (EAPOL М2). Задача атакующего - набрать таких handshake, используя подвижность или неприметность. После чего набранные handshake могут быть подвергнуты брутфорсу. Подробнее атака будет описана ниже.

![Четырехсторонее рукопожатие](4wayshandshake.png)

> Примечание: Если есть желание понять, как работает аутентификация с сервером RADIUS в корпоративных сетях по стандарту 802.1X, то читайте в приложенных материалах главу 3.3.1 Технологии современных беспроводных сетей Wi-Fi.pdf под общей редакцией А.В. Пролетарского

Также во многих современных бытовых Wi-Fi устройствах применяется режим **Wi-Fi Protected Setup (WPS)**, также именуемый Wi-Fi Easy Setup, где авторизация клиентов на точке доступа осуществляется при помощи специальной кнопки или вводом pin-кода, уникального для устройства. Один из самых быстрых способов взлома точки доступа это перебор WPS-ключей и перебор WPS-ключей для конкретного производителя.

Для случаев, когда в сети эксплуатируется фиксированный набор оборудования (т.е. например, мост, созданный при помощи двух точек доступа или единственный ноутбук, подключаемый к беспроводному сегменту домашней сети) минимально надёжным способом является ограничение доступа по MAC-адресу (уникальный адрес для каждого Ethernet устройства, как проводного, так и беспроводного) посредством прописывания в меню точки доступа списка MAC-адресов «своих» устройств и выбор разрешения доступа в сеть только устройствам с адресами из этого списка. Минимально надежным по той причине, что атакующий может подменить свой MAC-адрес на адрес жертвы, предварительно отключив жертву от сети. 

![Фильтрация клиентов по MAC-адресам](macblock.png)

По MAC-адресу можно узнать производителя, для этого есть удобные сервисы: https://2ip.ru/mac-address/

При отключении рассылки (broadcast) SSID сеть будет выглядеть для просматривающих доступные сети пользователей как безымянная, а для подключения необходимо знать и SSID, и пароль (в случае использования WPA-PSK), однако само по себе отключение SSID не делает сеть более устойчивой к несанкционированному проникновению извне.

#### Каналы

Когда клиент 802.11 попадает в зону действия одной или нескольких точек доступа, он на основе мощности сигнала и наблюдаемого значения количества ошибок выбирает одну из них и подключается к ней. Как только клиент получает подтверждение того, что он принят точкой доступа, он настраивается на радиоканал, в котором она работает. Время от времени он проверяет все каналы 802.11, чтобы посмотреть, не предоставляет ли другая точка доступа в инфраструктуре службы более высокого качества. Если такая точка доступа находится, то станция подключается к ней, перенастраиваясь на её частоту

Есть выделенные диапазоны радиочастот. 

![Каналы](ch_n.jpg)

Для лучшего использования они поделены на отдельные куски, которые называются каналами. В зависимости от региона и страны правила их использования могут меняться, поэтому важно, чтобы в настройках как роутера, так и остальных устройств регион был один и тот же. Иногда это определяется по косвенным признакам вроде раскладок клавиатуры, языка интерфейса, часового пояса, параметрам соседних сетей Wi-Fi и так далее. В диапазоне 5 ГГц, вероятнее всего, подойдут только каналы с 36-го по 48-й. Для 2,4 ГГц таких каналов есть 13 штук, но работа Wi-Fi на любом из них влияет и на соседние каналы тоже. Фактически не пересекаются и не мешают друг другу каналы с шагом в пять между собой: 1, 6 и 11. Хуже, но вполне допустимо и такое распределение: 1/4/7/11 или 1/5/9/13. Если же речь идёт о более современных стандартах с удвоенной шириной канала (40 МГц вместо 20 МГц), то места-то и вообще не остаётся: без пересечений будут работать, например, только 3-й и 11-й каналы.

![Покрытие помещения беспроводной сетью с точками доступа, оснащенными всенаправленными антеннами](channels.png)

Есть множество утилит для анализа эфира Wi-Fi: inSSIDer Lite, Acrylic Wi-Fi Home.  

![Анализатор эфира Wi-Fi](wifiexplorer.png)

### Процесс сбора информации о точке доступа

1. Необходимо настроить свое "рабочее место" - загрузить linux с live образа флешки или иметь Linux установленной ОС на ПК.
2. Также поднадобится сетевая Wi-Fi карта, которая поддерживает режим монитора. В установленных на ноутбуках сетевых картах проблем никогда не возникало. Но для некоторых атак, типа Evil Twin или если запускать linux как виртуальную машину (а не как описано в п.1), то необходимо купить внешнюю сетевую карту Wi-Fi. Также внешняя сетевая карта будет полезна для лучшей эффективности атак, так как они отличаются большей дальностью приема и передачи сигнала, чем те которые предустановлены в ноутбуках и мобильных. Соответственно улучшается покрытие и скорость атаки на клиента, так как часто атака происходит на дальшем расстоянии от точки, чем находится клиент важно иметь более сильный "передатчик". [Список актуальных карт](https://hackware.ru/?p=3328)
  
![](antenna.jpeg)


3. Перевод Wi-Fi адаптера в режим монитора
	
 	По умолчанию беспроводные адаптеры находятся в «управляемом» (managed) режиме. Этот режим позволяет подключаться к Точке Доступа в качестве обычного Клиента.
	Режим монитора (monitor) предназначен для анализа Wi-Fi сетей. В этом режиме беспроводная карта принимает фреймы (их ещё называют кадры) от любых источников, находящихся на том же канале.

	Поскольку нам нужно захватить рукопожатие, которое состоит из данных, которые Станция отправляет Точке Доступа и Точка Доступа отправляет Станции (т.е. которые ни на каком этапе не предназначены для нас), то нам необходимо перевести нашу Wi-Fi карту в режим монитора, чтобы она была способна увидеть эти данные и сохранить их для дальнейшей обработки.

  	`sudo iw dev`

  	Имя беспроводного интерфейса указано в строке со словом Interface, т.е. `wlan0`. Запоминаем это значение, поскольку в дальнейшем оно нам понадобиться.

  	Режим монитора не является чем-то обычным для операционной системы, поэтому некоторые программы без спроса, молча переводят Wi-Fi адаптер в управляемый режим. Нам это может помешать, поэтому следующими двумя командами мы закрываем программы, которые могут нам воспрепятствовать:

  	`sudo ip link set wlan0 down`

  	`sudo iw wlan0 set monitor control`

  	`sudo ip link set wlan0 up`

4. Запускаем любой сканер wifi (например `wash -i wlan0` или `airodump-ng`)

  Будет выведен похожий список сетей:

  ![](1.jpg)

  Когда вы увидите в списке сеть, которую хотите атаковать, то остановите программу, для этого нажмите CTRL+c.

5. Собираем значение BSSID точек доступа

  Предположим, нас интересует сеть с ESSID (именем) dlink. Как видно из скриншота, её характеристиками являются: BSSID – это 00:1E:58:C6:AC:FB, она использует WPA2, работает на шестом канале. Также ненулевое значение #Data (захваченные данные, отправляемые это ТД) позволяет предположить, что к ней подключена одна или более станций.

6. Захват WPA Handshake - одна из самых популярных и широкоприменяемых атак.
  
  ![](wpa_attack.png)

  WPA Handshake передается клиентом во втором сообщении (EAPOL М2) четырехступенчатого рукопожатия. Содержимое этого пакета является доказательством для точки доступа, что клиент знает общий ключ РSК. Злоумышленник же, перехватив такой хеш, может подобрать пароль перебором по словарю. Для захвата этого хеша злоумышленнику не обязательно совершать активные действия, но можно ускорить процесс через деаутентификацию клиентов конкретной точки доступа. Рассылка пакетов деаутентификации отправляет от имени клиента и точки доступа всем слышимым клиентам Wi-Fi сети специальные пакеты, закрывающие соединение (деаутентификация). Клиент, который на самом деле не собирался отключаться от точки доступа, выполнит повторное подключение, передав хеш пароля к этой сети. Деаутентификация имеет негативные побочные воздействия на атакуемую сеть - постоянные отключения клиентов.

  Для захвата рукопожатия используется команда следующего вида: `sudo airodump-ng -c КАНАЛ --bssid MAC_АДРЕС -w ФАЙЛ ИНТЕРФЕЙС` Где:
  - КАНАЛ – это канал, на котором работает ТД
  - MAC_АДРЕС – это BSSID атакуемой ТД
  - ФАЙЛ – имя файла, куда будет записано рукопожатие
  - ИНТЕРФЕЙС – имя беспроводного интерфейса в режиме монитора

  `sudo airodump-ng -c 6 --bssid 00:1E:58:C6:AC:FB -w capture wlan0`
	
  > Примечание: Стоит упомянуть, что есть вероятность захвата невалидного пароля, который также отправляется в виде пакетов handshake. Но handshake с таким паролем не содержит ответа от точки доступа (EAPOL МЗ), и считается половинчатым (Half-handhake). Чтобы не получить ложного срабатывания, необходимо отбрасывать такие handshakes и оставлять только те, которые имеют подтверждение, а значит, с правильным паролем. 

  На следующем скриншоте вновь видна интересующая нас ТД, а также теперь виден раздел со станциями:

  ![](2.jpg)

  В полном списке ТД раздел со станциями также присутствовал, но уходил за нижний край экрана, поэтому на скриншот не попал.

  Для станции мы в поле BSSID мы можем увидеть значение, которое соответствует BSSID Точки Доступа, т.е. 00:1E:58:C6:AC:FB, это означает, что в данный момент эта Станция подключена к интересующей нас ТД. Теперь имеется два варианта:
  1) ждать пока Станция отсоединится и вновь подключится к ТД по естественным причинам
  2) выполнить атаку деаутентификация для ускорения процесса

### Общие методы и конкретные способы атак на точку доступа

#### И тактики

https://attack.mitre.org/techniques/T0860/

![](WiFi-Hacking-MindMap-v1.png)

Точка доступа WiFi может быть уязвима к **атакам на пользователя** и к **атакам без его участия**. Вот несколько примеров уязвимостей и соответствующих атак:

**Атаки на пользователя**

- Атаки на пользователя:
	1. Перехват трафика: Злоумышленник может использовать инструменты, такие как "отравление кеша ARP" или "перехват пакетов", для перехвата и анализа сетевого трафика, передаваемого через беспроводную точку доступа.
 	2. Обход аутентификации WLAN – Общий ключ, фильтрация MAC, скрытые SSID
  3. DOS - Атаки "отравление кеша ARP" (ARP poisoning): Злоумышленник может использовать эту атаку для подмены ARP-таблицы (Address Resolution Protocol) в беспроводной сети. Это может позволить злоумышленнику перехватывать или изменять сетевой трафик между подключенными пользователями и точкой доступа, а также осуществлять атаки "Man-in-the-Middle" (MITM).
  4. Атаки "Man-in-the-Middle" (MITM): В атаках MITM злоумышленник позиционирует себя между точкой доступа и пользователями, чтобы перехватывать и изменять их сетевой трафик. Это может позволить злоумышленнику перехватывать конфиденциальные данные, такие как пароли или сессионные куки, или проводить другие атаки на пользователя.
  5. Атаки на протоколы шифрования: Если беспроводная сеть использует уязвимые протоколы шифрования или слабые ключи, злоумышленник может проводить атаки на шифрование, такие как атаки на WEP или атаки на WPA/WPA2 с использованием слабых паролей или словарей. Взлом шифрования WLAN – WEP, WPA/WPA2 для личных и корпоративных пользователей, понимание уязвимостей на основе шифрования (WEP, TKIP, CCMP)
  6. Атаки на пароль или аутентификацию: Злоумышленник может использовать атаки на пароль, такие как словарные атаки, брутфорс или атаки на слабые пароли, для получения доступа к точке доступа или к учетным записям пользователей.
  7. Атаки на уровне сеанса: Злоумышленник может попытаться атаковать сеанс связи между пользователем и точкой доступа, например, путем перехвата истории сеансов, подбора сессионных идентификаторов (Session ID) или подделки сессионных файлов.
  8. Атаки на физический уровень: Злоумышленник может попытаться физически вмешаться в работу беспроводной сети, например, путем блокировки или смещения сигнала WiFi или использования устройств, которые могут нарушить работу сети или перехватывать трафик. Атака на инфраструктуру WLAN - Устройства–мошенники, Злые близнецы, DoS-атаки, MITM, настройка защиты Wi-Fi
  9. Социальные атаки:
      - Приманки и атаки на точки доступа, Caffe-Latte, Hirte, сети Ad-Hoc и вирусные SSID, WiFishing
    	- Понижение защиты точки доступа
  10. Обход аутентификации WPA2/3 через [CVE-2023-52161](https://www.youtube.com/watch?v=o50ttLaMI9Y) позволяет злоумышленнику убедить целевого пользователя подключиться к вредоносной сети Wi-Fi и перехватить его трафик. Взаимодействие с пользователем не требуются, но для успешной атаки нужно находится неподалеку от жертвы и знать SSID корпоративной сети. 

**Атаки которые могут проводиться без подключенных к точке пользователей** 

- Атаки которые могут проводиться без подключенных к точке пользователей:
    1. Атаки на уровне протоколов: Некоторые уязвимости в самом протоколе Wi-Fi (например, WEP) могут быть использованы для атаки на точку доступа без активного участия пользователя.
    2. Уязвимости в программном обеспечении: Если точка доступа работает на уязвимом программном обеспечении или не обновлена до последней версии, злоумышленник может эксплуатировать уязвимости в программном обеспечении для получения несанкционированного доступа.
    3. WPS PIN - атака на аутентификацию точки доступа;
    5. FragAttack
    6. Атаки на пароль: Злоумышленник может использовать словарные атаки, брутфорс атаки или атаки по слабым паролям для получения доступа к точке доступа WiFi
    7. WPA/WPA2 Handshake/Ьruteforce - атака на аутентификацию точки доступа + радужные таблицы https://hackware.ru/?p=13762
    8. Key reinstallation attacks (KRACK) если есть ключ PMKID захват EAPOL M1 и брут
    9. DragonBlood
    10. Продвинутые корпоративные атаки направлены на обход 802.1x, EAP, LEAP, PEAP, EAP-TTLS
 
### Примеры инструментов (Examples of tools)

Тактика может быть исполнена на ОС linux с использованием сетевой карты поддерживающей режим монитора и дополнительных утилит:

- Manual:
  - [Bettercap](https://www.bettercap.org/)
  - [Scapy](https://scapy.net/)
  - [Wireshark](https://www.wireshark.org/download.html)
  - [Airmon/Airodump/Aireplay/Aircrack-ng](https://help.ubuntu.ru/wiki/wi-fi_sniffing)
  - [tshark](https://www.wireshark.org/docs/man-pages/tshark.html): For detecting WPS networks and inspecting handshake capture files.
  - [reaver](https://github.com/t6x/reaver-wps-fork-t6x): For WPS Pixie-Dust & brute-force attacks.
  - [bully](https://github.com/kimocoder/bully): For WPS Pixie-Dust & brute-force attacks
  - [coWPAtty](https://www.willhackforsushi.com/?page_id=50): For detecting handshake captures.
  - [pyrit](https://github.com/JPaulMora/Pyrit?ysclid=lu5p4bilc8619257882): For detecting handshake captures.
  - [hashcat](https://hashcat.net/hashcat/): For cracking PMKID hashes.
- Combines:
  - [Wifite2](https://github.com/derv82/wifite2)  
  - [Airgeddon](https://github.com/v1s1t0r1sh3r3/airgeddon)
  - [WiFi-autopwner](https://github.com/Mi-Al/WiFi-autopwner)
- Only EvilTwin attacks:
  - [EapHammer](https://github.com/s0lst1c3/eaphammer)

### Пример WPS - атака на аутентификацию точки доступа

Атака подбора WPS РIN-кода - еще один пример атаки на точку доступа Wi-Fi, требующей длительного времени. Беспроводных устройств с активным и подверженным к перебору WPS достаточно много: от тех же беспроводных принтеров до корпоративных точек доступа. В случае, если точка доступа не имеет некий стандартный PIN, либо не уязвима к Pixie Dust, позволяющему подобрать РIN-код за несколько попыток (секунд), полный перебор всего пространства РIN-кодов в худшем из сценариев для злоумышленника требует 11ООО попыток. Хорошо, если каждая из попыток пройдет хотя бы за 1 с. В результате, в самом идеальном случае, если точка доступа его не заблокирует, на эту атаку может потребоваться несколько часов

1. запускаем сканер wifi   
  
  `wash -i wlan0`
    
2. выбираем BSSID           
  
  начать стоит с сетей, которые 

  1. Lck No
  2. меньшим dBm
  3. WPS 1.0
  4. Realtek

3. запускаем перебор ключей с необходимым BSSID

  `reaver -i wlan0 -c 2 -b "BSSID" -K -vv --no-nacks -T .5 -d 3 3`


### Пример  Evil Тwin

Атака злой двойник» (Evil Twin) - это имитация беспроводной сети, к которой уже есть доверие. И доверие, в этом случае, у пользователей. Таким образом, Evil Twin - это беспроводная социальная атака, беспроводной фишинг, направленный именно на людей, а не на клиентские устройства. Так как не на все сети Wi-Fi можно выполнить ранее описанные атаки, и пароль злоумышленнику тоже удается подобрать далеко не всегда, то можно спросить этот пароль у самих пользователей, которые часто являются самым слабым звеном периметра. В этом случае настраиваем сетевую карту как точку доступа Wi-Fi с тем же именем сети, что и атакуемая. С той лишь разницей, что сеть является открытой. Атака полагается на факт доверия со стороны пользователя к подставной сети. Предполагается, что именно пользователь намеренно подключится к будто бы легальной беспроводной сети и введет пароль, который отправится прямо к злоумышленнику в открытом виде. Чтобы повысить вероятность того, что кто-то из пользователей подключится к подставной сети, можем отправлять пакеты деаутентификации, отключая всех клиентов от атакуемой беспроводной сети. Для успешности атаки Evil Twin злоумышленнику требуется грамотно решить две задачи: запустить беспроводную сеть с именем, которое точно привлечет внимание людей, и, конечно же, грамотный претекстинг Сарtivе портала. 

### Пример атаки на Wi-Fi методом перехвата PMKID

Почему же беспроводные роутеры вещают пароль от Wi-Fi буквально «в воздух», пусть и в зашифрованном виде? Дело в том, что это штатная функция [стандарта 802.11r](https://ru.wikipedia.org/wiki/IEEE_802.11r-2008), который реализован в большинстве роутеров и обычно включен по умолчанию. Данный стандарт описывает механизм быстрого роуминга в Wi-Fi-сетях, использующих несколько точек доступа. Чтобы ускорить переподключение клиентского устройства к новым точкам доступа, они постоянно передают в эфир свой идентификатор — тот самый PMKID.

Этот идентификатор представляет собой производную от ключа PMK (Pairwise Master Key, парный главный ключ). Если точнее, то в нем содержится результат вычисления хеш-функции SHA-1, в исходные данные которой входит этот самый ключ PMK и еще некоторое количество данных. А ключ PMK, в свою очередь, представляет собой производную от пароля Wi-Fi — то есть опять-таки результат вычисления хеш-функции SHA-1 от этого самого пароля.

Говоря по-простому, PMKID содержит пароль от беспроводной сети в дважды захешированном виде. В теории процесс хеширования необратим, то есть из полученного в результате хеширования значения невозможно восстановить исходные данные. Вероятно, на это и полагались создатели стандарта 802.11r, когда придумывали механизм быстрого роуминга с использованием PMKID.

Однако захешированные данные можно подбирать перебором. И этому особенно помогает тот факт, что люди довольно редко используют для беспроводных сетей действительно надежные пароли, а чаще всего полагаются на достаточно предсказуемые комбинации символов. Вот этого создатели 802.11r, очевидно, не учли.

Данная проблема [была обнаружена](https://hashcat.net/forum/thread-7717.html) несколько лет назад командой одной из наиболее популярных утилит для восстановления паролей — или, попросту говоря, для их взлома — Hashcat. С тех пор успели появиться и специализированные инструменты, предназначенные именно для взлома перехваченных PMKID.

![PMKID в перехваченном трафике](wireshark_pmkid.png)

PMKID вычисляется с помощью HMAC-SHA1, где ключом является PMK, а частью данных является конкатенация фиксированной строковой метки "PMK Name", MAC-адреса точки доступа и MAC-адреса станции.

`PMKID = HMAC-SHA1-128(PMK, "PMK Name" | MAC_AP | MAC_STA)`

Поскольку PMK такой же, как и при обычном 4-стороннем рукопожатии EAPOL, это идеальный вектор атаки.

Мы получаем все необходимые данные в первом кадре EAPOL от точки доступа.

**Как воспроизвести:**

1. Запустите hcxdumptool, чтобы запросить PMKID у точки доступа и сбросить полученный фрейм в файл (в формате pcapng).

`./hcxdumptool -o test.pcapng -i wlp39s0f3u4u5 --enable_status`

Если точка доступа получит наш пакет запроса на ассоциацию и поддержит отправку PMKID, мы увидим сообщение "FOUND PMKID" через некоторое время

> Примечание: Из-за шума в канале WiFi получение PMKID может занять некоторое время. Мы рекомендуем запускать hcxdumptool не более чем за 10 минут до прерывания.

2. Запустите hcxpcaptool, чтобы преобразовать захваченные данные из формата pcapng в формат хэша, принятый hashcat.

### Пример bruteforce handshake WPA/WPA2

- `tshark -r WPA2-PSK-Capture1.cap -Y 'eapol'`
- `aircrack-ng -w 1000000-password-seclists.txt WPA2-PSK-Capture1.cap`
- `asleap -C bssid - R bssid -W seclist.txt`

### Защита

- Использование WPA2/3
- Мониторинг сети на появление новых сетей и подключение к существующим
- Отключить WPS
- Обновить прошивку маршрутизатора и сменить пароль администратора с базового
- Сложные пароли у клиентов
	> ![Время брутфорса](password_len.png)
- Смена пароля у клиентов раз в 60 дней

Наша цель в типовой инфраструктуре - получение доступа к беспроводной сети WiFi

![Типовая инфраструктура](<2.1.png>)

# Задание

> Story: Вы составили словари паролей и решили проверить один из векторов проникновения во внутреннюю сеть - через Wi-Fi. По техническим причинам, в этом курсе мы не можем с вами провести атаку на настоящую точку доступа и снять трафик. Это несложная операция - достаточно находиться в зоне доступа ТД. Поэтому для вас уже есть готовый дамп сети, вы найдете его в папке с практикой.

1. На рабочем столе в образе kali linux провести анализ дампов сети pcap и найти подходящий для атаки `bruteforce WPA handshake по словарю` из найденных в открытых источника данных о сотрудниках.
2. Достать из pcap настоящий пароль
3. Дополнить отчет, где указать использованные подходы и затронутые угрозы безопасности. Отчет должен содержать название уязвимости, описание уязвимости, пример её эксплуатации, рекомендации к устранению. Указать найденный пароль. 

# Теоретические вопросы

1. В каких диапазонах работает сеть Wi-Fi?
2. На каких каналах работает сеть Wi-Fi?
3. Что находится в сообщении EAPOL М3 handshakes WPA2?

## Доп. материалы:

- https://habr.com/ru/articles/762232/
- https://habr.com/ru/articles/506812/
- https://teletype.in/@r00t_owl/7DwgIB6PbmI
- https://book.hacktricks.xyz/generic-methodologies-and-resources/pentesting-wifi
- https://hackmd.io/@ka0na5hi/HJRaz91Xd
- https://hackware.ru/?p=372
- https://github.com/blaCCkHatHacEEkr/PENTESTING-BIBLE
- https://hackmd.io/kYAqxmOjTE6-UAv6TubiiA
- https://codeby.net/threads/kak-stat-guru-ili-wifi-cheat-sheet.82346/
- https://executeatwill.com/2020/01/05/Wireless-Wifi-Penetration-Testing-Hacker-Notes/
- https://uceka.com/2014/05/12/wireless-penetration-testing-cheat-sheet/
- https://www.hackingloops.com/kick-victims-off-of-wireless-networks/
- https://gbhackers.com/wireless-penetration-testing-checklist-a-detailed-cheat-sheet/
- https://github.com/duyetdev/bruteforce-database/blob/master/1000000-password-seclists.txt
- https://github.com/derv82/wifite2
- https://www.freebuf.com/articles/wireless/338334.html
- https://wifigid.ru/besprovodnye-tehnologii/tehnologiya-802-11n-wi-fi-4-tsaritsa-wi-fi

Wifi maps
- https://raw.githubusercontent.com/koutto/pi-pwnbox-rogueap/main/mindmap/WiFi-Hacking-MindMap-v1.png
- https://github.com/ivan-sincek/wifi-penetration-testing-cheat-sheet